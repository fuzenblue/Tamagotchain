# Battle Result Flow Diagram

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        BATTLE SYSTEM                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Player 1   â”‚                              â”‚   Player 2   â”‚
â”‚  (Waiting)   â”‚                              â”‚ (Initiator)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                             â”‚
       â”‚ 1. enterBattle()                            â”‚
       â”‚    (0.01 ETH)                               â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚                                             â”‚
       â”‚                                             â”‚ 2. enterBattle()
       â”‚                                             â”‚    (0.01 ETH)
       â”‚                                             â”‚
       â”‚                                             â–¼
       â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                    â”‚  Smart Contract â”‚
       â”‚                                    â”‚  BattleArena    â”‚
       â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                             â”‚
       â”‚                                             â”‚ 3. Match Found!
       â”‚                                             â”‚    _executeBattle()
       â”‚                                             â”‚
       â”‚                                             â–¼
       â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                    â”‚  Calculate CP   â”‚
       â”‚                                    â”‚  CP1 vs CP2     â”‚
       â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                             â”‚
       â”‚                                             â”‚ 4. Determine Winner
       â”‚                                             â”‚    (Pseudo-random + CP)
       â”‚                                             â”‚
       â”‚                                             â–¼
       â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                    â”‚  Battle Result  â”‚
       â”‚                                    â”‚  Winner/Loser   â”‚
       â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                             â”‚
       â”‚                                             â”‚ 5. emit BattleEnded
       â”‚                                             â”‚    (battleId, winner,
       â”‚                                             â”‚     loser, reward)
       â”‚                                             â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                                             â”‚
       â”‚ 6a. Event Listener                          â”‚ 6b. Transaction Receipt
       â”‚     catches BattleEnded                     â”‚     contains BattleEnded
       â”‚                                             â”‚
       â–¼                                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ setBattleResult({                           â”‚ setBattleResult({
â”‚   winner,                                   â”‚   winner,
â”‚   loser,                                    â”‚   loser,
â”‚   isWinner,                                 â”‚   isWinner,
â”‚   reward                                    â”‚   reward
â”‚ })                                          â”‚ })
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                             â”‚
       â”‚ 7. Show Modal                               â”‚ 7. Show Modal
       â”‚    Automatically                            â”‚    Immediately
       â”‚                                             â”‚
       â–¼                                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ðŸŽ‰ or ðŸ’€   â”‚                              â”‚  ðŸŽ‰ or ðŸ’€   â”‚
â”‚ Battle Resultâ”‚                              â”‚ Battle Resultâ”‚
â”‚    Popup     â”‚                              â”‚    Popup     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Combat Power (CP) Calculation Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CP CALCULATION                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Pet Stats   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚               â”‚               â”‚
           â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Hunger  â”‚    â”‚Happiness â”‚   â”‚  Energy  â”‚
    â”‚   (H)    â”‚    â”‚   (Ha)   â”‚   â”‚   (E)    â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚               â”‚               â”‚
         â”‚ Ã— 0.3         â”‚ Ã— 0.2         â”‚ Ã— 0.5
         â”‚ (30%)         â”‚ (20%)         â”‚ (50%)
         â”‚               â”‚               â”‚
         â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  H Ã— 30% â”‚    â”‚ Ha Ã— 20% â”‚   â”‚  E Ã— 50% â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚               â”‚               â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   Total CP   â”‚
                  â”‚ = HÃ—0.3 +    â”‚
                  â”‚   HaÃ—0.2 +   â”‚
                  â”‚   EÃ—0.5      â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Example:
  Hunger = 90     â†’ 90 Ã— 0.3 = 27
  Happiness = 80  â†’ 80 Ã— 0.2 = 16
  Energy = 100    â†’ 100 Ã— 0.5 = 50
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Total CP = 27 + 16 + 50 = 93
```

## Battle Result Modal States

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MODAL DISPLAY LOGIC                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    battleResult exists?
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                     â”‚
               YES                   NO
                â”‚                     â”‚
                â–¼                     â–¼
         isWinner = true?      [No Modal]
                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
        â”‚               â”‚
       YES             NO
        â”‚               â”‚
        â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   WIN MODAL  â”‚  â”‚  LOSS MODAL  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ðŸŽ‰ YOU WON!  â”‚  â”‚ ðŸ’€ YOU LOST  â”‚
â”‚              â”‚  â”‚              â”‚
â”‚ Green Theme  â”‚  â”‚  Red Theme   â”‚
â”‚              â”‚  â”‚              â”‚
â”‚ Reward:      â”‚  â”‚ Lost:        â”‚
â”‚ 0.018 ETH    â”‚  â”‚ 0.01 ETH     â”‚
â”‚              â”‚  â”‚              â”‚
â”‚ [Close]      â”‚  â”‚ [Close]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Event Flow Timeline

```
Time â†’

Player 1                    Contract                    Player 2
   â”‚                           â”‚                           â”‚
   â”‚ enterBattle()             â”‚                           â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                           â”‚
   â”‚                           â”‚                           â”‚
   â”‚ Waiting in queue...       â”‚                           â”‚
   â”‚                           â”‚                           â”‚
   â”‚                           â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                           â”‚         enterBattle()     â”‚
   â”‚                           â”‚                           â”‚
   â”‚                           â”œâ”€â”                         â”‚
   â”‚                           â”‚ â”‚ Match players           â”‚
   â”‚                           â”‚ â”‚ Calculate CP            â”‚
   â”‚                           â”‚ â”‚ Determine winner        â”‚
   â”‚                           â”‚ â”‚ Transfer rewards        â”‚
   â”‚                           â”‚â—„â”˜                         â”‚
   â”‚                           â”‚                           â”‚
   â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
   â”‚                           â”‚   emit BattleEnded        â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
   â”‚   Event caught            â”‚                           â”‚
   â”‚                           â”‚                           â”‚
   â”‚ [Show Modal]              â”‚                  [Show Modal]
   â”‚                           â”‚                           â”‚
   â–¼                           â–¼                           â–¼
```

## Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DATA FLOW                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Smart Contract (Solidity)
    â”‚
    â”‚ emit BattleEnded(
    â”‚   battleId: uint256,
    â”‚   winner: address,
    â”‚   loser: address,
    â”‚   reward: uint256
    â”‚ )
    â”‚
    â–¼
Event Listener (useBattle.js)
    â”‚
    â”‚ contract.on('BattleEnded', (battleId, winner, loser, reward) => {
    â”‚   // Check if current user involved
    â”‚   if (winner === account || loser === account) {
    â”‚     setBattleResult({
    â”‚       winner,
    â”‚       loser,
    â”‚       isWinner: winner === account,
    â”‚       reward: reward.toString()
    â”‚     })
    â”‚   }
    â”‚ })
    â”‚
    â–¼
React State (MyPet.jsx)
    â”‚
    â”‚ const { battleResult, clearBattleResult } = useBattle()
    â”‚
    â–¼
UI Component
    â”‚
    â”‚ {battleResult && (
    â”‚   <BattleResultModal
    â”‚     winner={battleResult.winner}
    â”‚     loser={battleResult.loser}
    â”‚     isWinner={battleResult.isWinner}
    â”‚     reward={battleResult.reward}
    â”‚     onClose={clearBattleResult}
    â”‚   />
    â”‚ )}
    â”‚
    â–¼
User sees result!
```

## Component Hierarchy

```
MyPet.jsx
â”œâ”€â”€ usePet() hook
â”‚   â”œâ”€â”€ pet stats
â”‚   â”œâ”€â”€ feed/play/rest actions
â”‚   â””â”€â”€ cooldowns
â”‚
â”œâ”€â”€ useBattle() hook
â”‚   â”œâ”€â”€ battleResult â—„â”€â”€ NEW!
â”‚   â”œâ”€â”€ enterBattle()
â”‚   â”œâ”€â”€ clearBattleResult() â—„â”€â”€ NEW!
â”‚   â””â”€â”€ event listener â—„â”€â”€ UPDATED!
â”‚
â””â”€â”€ UI Components
    â”œâ”€â”€ Pet Display
    â”œâ”€â”€ Stats Bars
    â”œâ”€â”€ Action Buttons
    â”œâ”€â”€ Stats Modal
    â”œâ”€â”€ Purchase Modal
    â””â”€â”€ Battle Result Modal â—„â”€â”€ NEW!
        â”œâ”€â”€ Win Screen (ðŸŽ‰)
        â””â”€â”€ Loss Screen (ðŸ’€)
```

## State Management

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STATE MANAGEMENT                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

useBattle Hook State:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ const [battleResult, setBattleResult] = useState(null)       â”‚
â”‚                                                              â”‚
â”‚ Structure:                                                   â”‚
â”‚ {                                                            â”‚
â”‚   winner: "0x1234...",      // Winner's address             â”‚
â”‚   loser: "0x5678...",       // Loser's address              â”‚
â”‚   isWinner: true/false,     // Is current user winner?      â”‚
â”‚   reward: "18000000000000000" // Reward in wei (string)     â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Lifecycle:
1. Initial: null (no modal)
2. Battle ends: { winner, loser, isWinner, reward }
3. User clicks close: null (modal disappears)
4. Next battle: { new data } (modal reappears)
```

## Key Functions

```javascript
// 1. Parse Transaction Receipt (for initiator)
const enterBattle = async () => {
  const tx = await writeContract('enterBattle', [], { value })
  const receipt = await tx.wait()
  
  for (const log of receipt.logs) {
    const parsedLog = contract.interface.parseLog(log)
    if (parsedLog.name === 'BattleEnded') {
      setBattleResult({
        winner: parsedLog.args.winner,
        loser: parsedLog.args.loser,
        isWinner: parsedLog.args.winner === account,
        reward: parsedLog.args.reward.toString()
      })
    }
  }
}

// 2. Listen to Events (for waiting player)
const listenToBattleEvents = () => {
  const handleBattleEnded = (battleId, winner, loser, reward) => {
    if (winner === account || loser === account) {
      setBattleResult({
        winner,
        loser,
        isWinner: winner === account,
        reward: reward.toString()
      })
    }
  }
  
  contract.on('BattleEnded', handleBattleEnded)
  return () => contract.off('BattleEnded', handleBattleEnded)
}

// 3. Calculate CP (in contract)
function calculateCP(address _owner) public view returns (uint256) {
  Pet storage pet = pets[_owner];
  uint256 cp = (pet.hunger * 30 / 100) + 
               (pet.happiness * 20 / 100) + 
               (pet.energy * 50 / 100);
  return cp;
}
```

---

## Summary

This implementation provides:
- âœ… Real-time battle results for both players
- âœ… Accurate CP calculation based on pet stats
- âœ… Beautiful UI with win/loss animations
- âœ… Event-driven architecture for instant updates
- âœ… No page refresh required
- âœ… Works for both initiator and waiting player
